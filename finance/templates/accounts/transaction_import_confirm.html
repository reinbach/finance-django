{% extends "base.html" %}
{% load bootstrap3 %}

{% block page-content %}
  <h1 class="page-header">Transactions</h1>

  <h2 class="sub-header">Confirm Import Transactions</h2>
  <div class="table-responsive">
    <form method="post" action="{% url 'accounts.transaction.import.confirm' %}" role="form" class="form-inline">
      {% csrf_token %}
      {% bootstrap_form form.management_form %}
      <table class="table table-striped">
        <thead>
          <tr>
            <th>#</th>
            <th>Debit</th>
            <th>Credit</th>
            <th>Amount</th>
            <th>Summary</th>
            <th>Date</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for f in form %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>
                {% bootstrap_field f.account_debit layout="inline" %}
                <button type="button" class="btn btn-default" data-toggle="modal" data-target="#accountAddModal" title="Add Account">
                  +
                </button>
              </td>
              <td>
                {% bootstrap_field f.account_credit layout="inline" %}
                <button type="button" class="btn btn-default" data-toggle="modal" data-target="#accountAddModal" title="Add Account">
                  +
                </button>
              </td>
              <td>{% bootstrap_field f.amount layout="inline" %}</td>
              <td>{% bootstrap_field f.summary layout="inline" %}</td>
              <td>{% bootstrap_field f.date layout="inline" %}</td>
              <td>{% bootstrap_field f.DELETE layout="inline" %}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      {% buttons %}
        <input type="submit" class="btn btn-success" value="Import Transactions" />
        <a href="{% url 'accounts.transaction.list' %}" class="btn btn-danger">Cancel</a>
      {% endbuttons %}
    </form>
  </div>

  <div class="modal fade" id="accountAddModal" tabindex="-1" role="dialog" aria-labelledby="accountAddModal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="post" action="{% url 'accounts.account.add' %}" role="form" id="account-form">
          {% csrf_token %}
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title" id="accountAddModalLabel">Add Account</h4>
          </div>
          <div class="modal-body" id="accountAddModalBody">
            {% bootstrap_form form_account %}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Add Account</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock page-content %}

{% block page-js %}
  <script>
    $(function() {
        var acctForm = $("#account-form");
        acctForm.submit(function() {
            $.ajax({
                type: acctForm.attr("method"),
                url: acctForm.attr("action"),
                data: acctForm.serialize(),
                success: function(data) {
                    updateAccountOptions(data.result);
                    $("#accountAddModal").modal("hide");
                    // update all debit/credit with same summary value
                },
                error: function(data) {
                    $("#accountAddModalBody").html(data.result);
                }
            });
            return false;
        });
    });

    function updateAccountOptions(options) {
        $("select").each(function() {
            var cur_value = $(this).val();
            console.log("cur: " + cur_value);
            $(this).html(options);
            $(this).val(cur_value);
        });
    }
  </script>
{% endblock page-js %}
